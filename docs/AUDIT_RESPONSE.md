# 監査指摘への見解

監査結果に対する見解を、指摘順にまとめています。**修正方針の合意用**であり、実装は別途進める想定です。

---

## 1) 重大 — 見解

### A. Claim API が「無制限の引き出し券発行機」になっている

**見解: 指摘の通りであり、重大です。現状のまま公開するのは危険と認識しています。**

- **事実**: `api/claim.js` は `req.body.amount` を検証（正の整数）したうえでそのまま `amountWei` にし、署名して返している。コントラクト `RewardClaim.sol` は「署名が正しければ pool から transferFrom」するだけなので、**サーバが署名してしまう限り、第三者が任意の amount を指定して API を叩けば、理論上はプールから任意額を引き出せる**。
- **CORS `*`**: その通りで、任意オリジンから POST 可能な状態です。API の危険性とあわせて、公開前に必ず直す必要があります。

**対処案への賛否**:

| 監査の提案 | 見解 |
|------------|------|
| amount をクライアントから受け取らず、サーバで「このアドレスが引き出せる上限」を計算し、その値だけ署名する | **賛成。** 権威をサーバ（またはオンチェーン）に置く必要があります。現状は「claimable」がクライアント（GameStore / localStorage）のみなので、サーバ側で「このアドレスが何 SEED まで claim 可能か」を計算する仕様に変える必要があります（オンチェーンのファーミング結果と整合する計算か、別のソースを決める必要あり）。 |
| CORS を自ドメインに固定 + rate limit（IP/アドレス単位） | **賛成。** 公開時は必須レベルです。 |
| nonce をアドレスごとにサーバで永続化し単調増加にする | **賛成。** リプレイ・衝突を避けるうえで妥当です。 |

**運用面**: 「直すまで公開環境では claim 機能を無効化（API を落とす／鍵を抜く）」には**同意**します。フロントでボタンを隠すだけでは API が叩かれる可能性が残るため、API 側で止める必要があります。

---

## 2) 高 — 見解

### B. “オンチェーン前提”と“ローカル改ざん可能”が混在している

**見解: 指摘の通りです。P2E/報酬に絡む数値の権威をどこに置くかは、公開前に方針を決める必要があります。**

- **事実**: GameStore は localStorage ベースで、ウォレットアドレスごとにキーを分けている。クライアントで「claimable（SEED）」を計算・表示しており、**localStorage を改ざんすれば表示上の SEED は増やせる**。現状は「Claim API が amount をそのまま署名する」ため、改ざんした値を API に送れば（A の脆弱性と組み合わせて）不正に多額を請求できてしまう。
- **方針**: 「改ざんされて困るものはサーバ or チェーン」「困らないものはクライアント」という分離に**同意**します。**claimable はクライアント計算に依存しない**形にし、サーバ（またはオンチェーン）で「このアドレスがいくらまで claim 可能か」を決める設計にすることが必要です。A の修正（サーバで claimable を計算して署名）と一体で対応する想定です。

---

### C. domShell.ts が肥大している

**見解: 指摘の趣旨には同意します。セキュリティ直接要因ではないが、変更時の事故や「つぎはぎ化」を防ぐため、境界を整理する価値はあります。**

- **事実**: domShell がタブ制御・モーダル・紙吹雪・ガチャ実行・チェーン表示・オンボーディングなど多くの責務を持っている。
- **方針**: 「domShell はルーティング（タブ切替）＋最小の共通 UI に縮退し、UI 生成は views に閉じる」という方向性に**同意**します。ただし、**優先度は「1) 重大」「2-B」のあと**とし、Claim API と権威データの修正を先に行ったうえで、リファクタとして進めるのが現実的だと考えます。

---

## 3) 中 — 見解

### D. 依存関係の棚卸し・デプロイ単位の分離

**見解: 運用・攻撃面の整理として妥当です。公開前にやれるとよいです。**

- **事実**: フロント・API・コントラクトが同一 repo にあり、package.json も同居している。
- **方針**: `npm audit` を CI で回すこと、フロント配布物に server や開発スクリプトが混ざらないようにすることには**同意**します。デプロイ単位の分離（frontend / api / contracts）は、リポジトリ分割までしなくても、**ビルド・デプロイ設定で「何がどこに含まれるか」を明確にする**だけでも一歩です。必要に応じてモノレポのままサブパスで分離する形でもよいと思います。

---

### E. XSS / innerHTML

**見解: 指摘のリスクは理解しています。現状は固定文言・数値中心だが、今後の拡張でユーザー入力や外部データを差し込む場合は危険です。**

- **事実**: domShell や views で `innerHTML` を使用している箇所がある（モーダル、ネットワーク統計のリストなど）。現状は数値や固定ラベルの組み立てが主。
- **方針**: 「原則 `textContent` + `createElement`」「どうしても innerHTML を使う箇所は入力を通さないと明記」に**同意**します。**優先度は 1・2 のあと**で、新規コードでは innerHTML を避け、既存箇所はリファクタ（C の domShell 縮退など）のタイミングで置き換えていく形が現実的です。

---

## 4) 監査の「今の時点での答え」への見解

- **無駄**: UI/DOM 統合ファイルの肥大とリポの同居によるデプロイ面の無駄 — **同意**。C と D で段階的に改善する想定です。
- **セキュリティ最大リスク**: Claim API（任意額署名） — **同意**。最優先で対処します。
- **公開耐性**: プロトとしては妥当だが、報酬・価値が出る瞬間に破綻しやすい設計 — **同意**。A と B を直したうえで「claimable の権威をサーバ/チェーンに置く」形にしないと、公開は危険です。

---

## 5) 監査提案の「進め方」への見解

| 順番 | 提案内容 | 見解 |
|------|----------|------|
| 1 | 公開前ブロッカー: Claim API（amount を受け取らない + CORS 制限 + rate limit） | **その通り。最優先で実施します。** |
| 2 | 権威データの切り分け（AuthoritativeState など、形だけでも分離） | **同意。** A の「サーバで claimable を計算」と整合する形で、クライアントの「表示用」と「サーバが認める claimable」を分離します。 |
| 3 | domShell の縮退（タブ・共通以外を views に） | **同意。** 1・2 のあとのリファクタとして進めます。 |
| 4 | 自動チェック（ESLint, TS strict, npm audit, build, 簡易 E2E） | **同意。** CI に組み込み、可能な範囲から導入します。 |

---

## まとめ

- **重大（A）**: 指摘どおり。Claim API は「amount をサーバで決める」設計に変更し、CORS と rate limit をかけるまで、公開環境では claim を無効化する。
- **高（B, C）**: B（権威の分離）は A と一体で対応。C（domShell 縮退）は 1・2 のあとのリファクタとする。
- **中（D, E）**: D は CI とデプロイ境界の整理で対応。E は新規は避け、既存はリファクタ時に textContent/createElement に寄せる。
- **進め方**: 監査提案の 1 → 2 → 3 → 4 の順で進める方針で一致しています。

この見解をベースに、まず 1（Claim API の仕様変更と無効化）から具体的な設計・実装に落とし込むのがよいと思います。

---

# 追加指摘への見解（第二ラウンド）

---

## 重大 1：NetworkState が“誰でも好きに改ざんできる公式データ”になっている

**見解: 指摘の通りです。現状のコントラクトは権限制御がなく、誰でも任意の値で更新できます。**

- **事実**: `NetworkState.sol` の `updatePower` / `setLoftLevel` / `addRarityCounts` はすべて `external` で、`msg.sender` 以外の制限がない。第三者が任意の power・level・レアリティカウントを送信でき、totalPower や levelCounts / globalRarityCounts を意図的に歪められる。
- **結論**: NetworkState を「公式値」として報酬計算や権威データに使う設計は**破綻している**と認識しています。UI の「世界の統計」「ネットワークシェア」表示に使っている限り、**荒らしで数値が歪むリスクは受容するか、扱いを変えるか**のどちらかになります。

**対策案への賛否**:

| 監査の提案 | 見解 |
|------------|------|
| NetworkState を「信頼不要な表示専用」と割り切る（統計に価値を持たせない） | **賛成。** 現実的には、**オンチェーンは“飾り（表示）”** と割り切り、報酬の正当性はサーバが持つ方針（後述 A）と整合します。UI 上も「参考値」である旨を明示するなど、ユーザー期待を「公式の正しい数値」にしない運用がよいです。 |
| 価値を持たせるなら onlyOwner / 署名などで更新権限を設ける | **同意。** 将来的にオンチェーンを「正」にしたい場合（B）の選択肢です。現時点では設計・運用コストを考えると A 寄せの方が現実的と判断しています。 |

---

## 重大 2：Claim 署名が「ドメイン分離なし」＝流用・横展開に弱い

**見解: 指摘の通りです。署名に chainId / contract が含まれておらず、流用・リプレイのリスクがあります。**

- **事実**: `RewardClaim.sol` は `hash = keccak256(abi.encodePacked(msg.sender, amount, nonce))` を `signMessage` で署名検証している。**chainId も contract address もハッシュに含まれていない**ため、同じ signer を使う別コントラクト／別チェーンで同形式の検証をされると、署名が流用される可能性がある。
- **方針**: **EIP-712 Typed Data で署名する**（domain に chainId + verifyingContract を含める）か、少なくとも `abi.encodePacked(address(this), block.chainid, user, amount, nonce)` のようにドメイン分離する — いずれも**賛成**です。Claim API の「amount をサーバで決める」修正とあわせて、署名仕様も EIP-712（または同等のドメイン分離）に変更するのがよいと考えます。

---

## 重大 3：Claim API は依然として“無制限の署名発行機”

**見解: 前回指摘と同じ内容であり、見解に変更はありません。**

- クライアント申告の `amount` をそのまま署名して返していること、CORS が `*` であることはその通りです。**公開前に必ず修正し、直すまでは claim を無効化する**方針で一致しています。

---

## 高リスク：プールの「無制限 approve」＋署名設計の組み合わせ

**見解: 指摘のリスクはその通りと認識しています。**

- **事実**: `approve-reward-claim.cjs` でプールが RewardClaim に `type(uint256).max` で approve している。署名が漏れる（または API が任意額を署名する）と、プール残高まで一括で引き出せる。
- **方針**:
  - **署名鍵の管理**: KMS/HSM 相当や Secret Manager での管理に**同意**します。運用として可能な範囲で厳格化する。
  - **approve を「必要額だけ」または「上限付き」に**: 運用コスト（都度 approve や定期的な更新）とのトレードオフはあるが、**リスク低減の選択肢としては有効**と認識しています。まずは署名の正当性（amount をサーバで決める＋EIP-712）と鍵管理を徹底し、そのうえで必要に応じて approve 方針を検討する形でよいと思います。
  - **署名設計の EIP-712 化**: 重大 2 と同様、**賛成**です。

---

## 中リスク：Vite 環境変数（VITE_ はクライアントに焼き込まれる）

**見解: 指摘のとおりであり、運用で「うっかり」を防ぐ必要があります。**

- **事実**: `VITE_` で始まる環境変数はビルド時にフロントにバンドルされ、公開情報になる。現状はアドレス類（`VITE_CLAIM_API_URL`, `VITE_SEED_TOKEN_ADDRESS` など）を参照しており、秘密鍵は含んでいない — **構造としては問題ない**と認識しています。
- **方針**: **CI での secret scan、.gitignore、Vercel 等の環境変数運用の明確化**には**賛成**です。ドキュメントや README に「VITE_ には秘密を入れない」と明記し、レビュー・オンボーディングで共有しておく価値があります。

---

## 結論（プロ監査目線）への見解

- 「重大な穴はある」「公開前に必須対応は Claim まわり（署名の正当性＋EIP-712）と NetworkState の扱い」 — **同意**です。
- 対応の優先順は、(1) **Claim API の修正（amount をサーバで決める＋CORS＋rate limit＋nonce）** と **(2) Claim 署名の EIP-712 化**、(3) **NetworkState を「表示専用・価値を持たせない」と割り切る** の順で現実的だと考えます。

---

## 分岐「A vs B」への見解

監査の整理どおり、**どちらに寄せるかで最短の修正案が変わります。**

| 選択肢 | 内容 | 見解 |
|--------|------|------|
| **A** | オンチェーンは“飾り（表示）”で、報酬の正当性はサーバが持つ | **現時点では A 寄せを推奨します。** NetworkState は無害化（価値ゼロの統計・表示専用）とし、Claim はサーバで claimable を計算して署名する。サーバ負担は増えるが、コントラクトの権限制御や検証ロジックの大がかりな変更を避けられ、短期で公開耐性を確保しやすいです。 |
| **B** | オンチェーンを“正”にしたい | 将来的に検討するなら、NetworkState に更新権限（onlyOwner / バックエンド署名など）や、power/level の正当性を検証するロジックが必要になります。設計・実装・運用のコストが増えるため、まずは A で固め、必要になった段階で B に寄せる方が現実的だと考えます。 |

**まとめ**: 「サーバ負担を増やしたくない」という方針を踏まえつつも、**公開リスクを下げる最短経路は「A 寄せ」**（オンチェーンは表示専用、Claim の正当性はサーバ）と判断しています。監査の「現実的には A 寄せが堅い」という結論に**同意**します。

---

以上を追加指摘への見解として記録します。実装に進む際は、A 寄せを前提に Claim API・署名仕様・NetworkState の扱いを仕様化するとよいと思います。

---

# A 寄せの最小仕様（合意追記）

監査側からの指摘を受けて、**「サーバで claimable を計算」の根拠を確定させる前に実装に入ると破綻しやすい**との前提で、A 寄せで進める場合の**最小仕様**を合意として以下に追記する。実装はこの仕様を満たすこと。

---

## Claim API

- **amount は受け取らない**。サーバが「このアドレスが引き出せる額」だけを署名する。
- サーバは **`claimable_total`**（そのアドレスがこれまでに引き出し可能になった累計）と **`claimed_total`**（そのアドレスがすでに引き出した累計）を保持し、**差分（claimable_total - claimed_total）のみ**を署名する。二重請求・並列リクエスト対策として必須。
- **nonce の単調増加だけでは二重取りは防げない**。**差分計算と原子的な更新**（署名を返すと同時に claimed_total を増やす等）が必須。
- **セッション認証（SIWE 等）を入れる**。CORS / rate limit は補助であり、本質的な対策は「誰がそのアドレスであるか」の認証とする。

---

## 署名仕様

- **EIP-712** で署名する。
- **deadline（短い有効期限）** を payload に含め、コントラクト側でも検証する（期限切れ署名は reject）。
- **domain** に **chainId** と **verifyingContract** を含める（他チェーン・他コントラクトへの流用を防ぐ）。

---

## NetworkState

- **「公式値ではない」** 扱いを **UI と仕様に明示**するか、表示自体を削る。どちらかで運用を確定する。

---

以上を A 寄せの最小仕様として合意に追記する。実装・テストはこの仕様に沿って行う。
