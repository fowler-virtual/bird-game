# なぜ Hyper Farm は幅を狭めても綺麗で、私たちのゲーム（デッキ）は綺麗に表示されないのか

数値だけの話ではなく、**設計思想の違い**が原因です。

---

## 1. Hyper Farm のレイアウト：**CSS 任せ（宣言的）**

- 画面は **HTML + Tailwind（Flexbox/Grid）** で構成されている。
- 各要素のサイズ・位置は **CSS のルール**で決まる（`flex`, `grid`, `max-w-7xl`, `md:` ブレークポイントなど）。
- ウィンドウをリサイズすると：
  1. ブラウザが **1回のリフロー**で全体を再計算する
  2. それに従って要素が並び変わる
- **JavaScript で「今の幅を読んで、自分でレイアウトを計算して、各要素を動かす」処理はしていない。**

→ 「幅が変わったらどう並ぶか」は **ブラウザのレイアウトエンジンが全部やってくれる**ので、狭くしても自然に綺麗に収まります。

---

## 2. 私たちのゲーム（デッキ）のレイアウト：**JS 任せ（命令的）**

- デッキ画面は **Phaser の 1 枚の canvas** の上に、デッキ枠・インベントリなどを **全部 JS で描いている**。
- canvas のサイズは **自分では決まらない**。親 DOM のサイズを **JS で読んで**、Phaser に教える必要がある。
- 流れはこうなっている：

```
ウィンドウリサイズ
  → debounce
  → scale.refresh()
  → (Deck タブのとき) requestAnimationFrame × 2 で「リフロー後」を待つ
  → getDeckParentRect() で #shell-content-inner / #shell-canvas-card の getBoundingClientRect() を取得
  → setParentSize(w, h) + scale.refresh() で canvas のサイズを更新
  → getDeckLayout() で「幅 w に対する」列数・行数・スロットサイズ・パネル位置などを**自前で計算**
  → applyDeckLayout() で Phaser オブジェクトの x, y, width, height を**ひとつずつ設定**
  → renderDeckUI() で再描画
```

- つまり **「今の幅」を読むタイミング**と**「その幅に合わせたレイアウト計算」**の両方を、私たちのコードが全部やっている。

→ ここで次のような問題が起きやすい：

1. **読むタイミング**  
   リフローが終わる前に `getBoundingClientRect()` を読むと、まだ古い（広い）サイズのまま → 狭くしてもレイアウトが切り替わらない。
2. **読む対象**  
   親に `min-width: auto` があると、子の canvas に引きずられて親が縮まない → 読む幅がずっと広いまま（`min-width: 0` で対策した部分）。
3. **自前のレイアウト計算**  
   `getDeckLayout()` の 820px / 880px のヒステリシスや、`slotSize` / `standbyCell` などの計算が、すべての幅で「綺麗」になるようにはなっていない可能性。
4. **Phaser の都合**  
   `setParentSize` → `refresh` のタイミングや、RESIZE モード時の内部状態に依存しており、DOM だけでは完結しない。

---

## 3. まとめ：根本的な違い

| 観点 | Hyper Farm | 私たちのゲーム（デッキ） |
|------|------------|---------------------------|
| **レイアウトの決定者** | ブラウザ（CSS） | 私たちの JS コード |
| **リサイズ時の処理** | ブラウザのリフローだけ | 「サイズを読む → canvas をリサイズ → 自前でレイアウト計算 → オブジェクトを並べ直す」の一連の JS |
| **「綺麗に表示される」理由** | 幅に応じた見た目が CSS で定義されており、ブラウザが一貫して適用するから | （狭い幅で綺麗に見せるには）上記の「読むタイミング」「読む対象」「レイアウト計算」「Phaser の更新」のすべてが正しく噛み合う必要があるから |
| **壊れやすいポイント** | ほぼない（ネイティブのレイアウト） | タイミング・対象要素・定数・Phaser の挙動のどれかがずれると表示が崩れる |

つまり、

- **Hyper Farm が綺麗なのは**、「幅を変えてもブラウザが CSS のルールで一括してレイアウトする」から。
- **私たちのデッキが狭い幅で綺麗になりにくいのは**、「幅の変化に合わせて、JS でサイズを読んで canvas をリサイズし、さらに中身のレイアウトまで全部 JS で計算・配置している」から。

数値を合わせるだけでは根本は変わらず、**「レイアウトを誰が・いつ・どう決めるか」が CSS 駆動か JS 駆動かという設計の差**が、見た目の安定性の差になっています。
