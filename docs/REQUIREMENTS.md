# 要件集約

手戻りを防ぐため、スコープ・方針・制約・検証条件をここに集約する。詳細は各参照ドキュメントへ。

---

## 1. 対応環境（スコープ）

| 項目 | 内容 |
|------|------|
| **対象** | **PC ブラウザ** ＋ **スマホのウォレットアプリ内ブラウザ** のみ。 |
| **対象外** | スマホの通常ブラウザ（Chrome 等）での WalletConnect 対応は**行わない**。 |
| **技術** | Phaser 3 + TypeScript + Vite。ウォレットは EIP-1193（`window.ethereum`）。本番は Sepolia テストネット。 |

---

## 2. 最優先目標

- **Git デプロイ版 ＋ スマホ・メタマスク** でも、**ローカル（PC・Chrome）で確認した動きと同等**にすること。
- 進め方: 「差異を出さない設計」（タイムアウト・フォールバック・同一コードパス）＋ エミュレーター or 実機での検証。細かい UX より先にこの parity を最優先する。
- 詳細: `docs/DEV_FLOW_AND_MOBILE.md` 参照。

---

## 3. 全体の構成と各画面（タブ）でできること

### 3.1 画面の流れ

1. **タイトル画面** — Connect Wallet ボタンのみ。接続するとゲームシェル（タブ付き）が表示される。
2. **ゲームシェル** — 接続後に表示。画面上部に共通のステータス（SEED/DAY、$SEED、Network Share 等）、その下にタブ（FARMING / ADOPT / LOFT / NETWORK / DEBUG）。

### 3.2 タブ一覧とできること

| タブ | 内容・できること |
|------|------------------|
| **FARMING** | **Loft グリッド**（デッキに配置した鳥の一覧表示）。経過時間で **SEED** が増加（デッキに鳥が1羽以上いるとき）。**LOFT Upgrade** で $SEED を消費して枠を追加（2→4→6→8→10→12 枠）。※ デッキの保存（SAVE）は **LOFT タブ**で行う。Farming タブには SAVE ボタンはない。 |
| **ADOPT** | **ガチャ**。$SEED を消費して鳥を1羽または10羽引く。獲得した鳥は待機リスト（インベントリ）に追加。初回プレイ時はここから誘導される。 |
| **LOFT**（Deck） | **デッキ枠（A〜L）** と **待機リスト（インベントリ）**。鳥をタップして配置先スロットを選ぶとデッキに配置。スロットをタップすると鳥を外せる。解放済み枠だけ配置可能（枠数は LOFT レベルで 2〜12）。**SAVE ボタンはこのタブ（LOFT）にのみある。** 押すとデッキをオンチェーンに保存し、SEED/DAY・Network Share を更新。 |
| **NETWORK** | オンチェーンの **Network Share %** と **LOFT レベル分布** を表示。Save やガチャ後に更新。 |
| **DEBUG** | 開発・デバッグ用。SEED の Set、Loft Level の切り替え、オンチェーン再取得、Reset & Disconnect など。**$SEED はオンチェーン由来のため表示のみ（書き換え不可）**。通常プレイでは不要。 |

### 3.3 共通・その他

- **画面上部（ステータス）**: SEED（放置報酬）、$SEED 残高、Network Share、Claim ボタン、Disconnect 等。タブをまたいで表示。
- **オンボーディング**: 初回は「ADOPT でガチャ → LOFT で鳥を配置 → **LOFT で SAVE**」の順に誘導。完了まで他タブはロックされる場合あり。
- **SAVE ボタンの位置**: デッキのオンチェーン保存（SAVE）ボタンは **LOFT タブにのみ**ある。**FARMING タブには SAVE ボタンはない。** 検証・手順書で「Save」と書く場合は LOFT タブの操作を指す。
- データは **localStorage** に保存（ウォレットアドレスごとに分離）。

---

## 4. 製品仕様（要約・補足）

- **宝石**: 画面上部で Sapphire / Ruby / Emerald / Diamond の所持数を表示（ゲーム内通貨の一種）。
- **$SEED**: ガチャ・LOFT 解放で消費。**オンチェーン残高と連携しており、クライアントからは書き換え不可**（デバッグタブでも表示のみ）。
- **SEED**: デッキに鳥を置いていると経過で増加。Claim で $SEED として引き出し可能（Claim API 経由）。
- 起動・ビルド・確認手順: リポジトリ直下 `README.md` 参照。

---

## 5. 検証開始条件（DoR）

監査・UI 検証を開始する前に、以下を**手動で**満たしていることを確認する。

1. **TOP が表示される** — タイトル画面（Connect Wallet ボタン）が表示され、崩れ・白画面でないこと。
2. **Connect Wallet が反応する** — クリックで「Connecting...」やゲーム画面への遷移など、何らかの反応があること。
3. **主要画面へ遷移できる** — 接続後、Farming / Deck / Adopt のいずれかのタブで画面が切り替わること。

上記を満たしたうえで検証に進む。検証は手動で行う。

---

## 6. 監査で合意した方針（制約・優先順）

| 順 | 内容 | 方針 |
|----|------|------|
| 1 | Claim API | amount をクライアントから受け取らない。サーバで「このアドレスが引き出せる上限」を計算し、その値だけ署名。CORS 自ドメイン固定 ＋ rate limit。**Vercel 本番**: claimable を game-state の seed から算出し、KV で claimed/reserve を管理して署名を返す実装済み（`api/claim.js`・`api/claimable.js`・`api/claim/confirm.js`）。 |
| 2 | 権威データ | claimable はサーバ（またはオンチェーン）で計算。クライアントの「表示用」と「サーバが認める claimable」を分離。 |
| 3 | domShell | タブ・共通以外を views に縮退。1・2 のあとのリファクタで実施。 |
| 4 | 自動チェック | ESLint, TS strict, npm audit, build を CI に組み込み。 |
| 5 | XSS / innerHTML | 新規は innerHTML を避け、既存はリファクタ時に textContent/createElement に寄せる。 |

詳細・経緯: `docs/AUDIT_RESPONSE.md`。Claim の具体設計: `docs/CLAIM_SAFETY_DESIGN.md`。

---

## 7. 開発・検証の流れ（方針）

- **開発は基本ローカル**で行う。
- **検証はほぼローカルで終わらせる**。オンチェーン周りの処理はローカル環境でも本番（Vercel）と同一の条件で検証し、問題なければ **Git に push** して **Vercel では最終チェック**のみ行う。

### 7.1 ローカル検証でできること

- **ウォレット接続（MetaMask / Rabby）**: ローカルで `pnpm run dev` してブラウザで開いても、拡張機能は同じように「接続」に反応する。**Vercel と同様に接続できる。**
- **$SEED 残高・ガチャ（$SEED 支払い）・Loft 支払い・Save**: いずれも**オンチェーン（Sepolia）の同じコントラクト**を叩く。ローカルの `.env` に `VITE_SEED_TOKEN_ADDRESS` / `VITE_SEED_TREASURY_ADDRESS` など本番と同じ値を入れれば、**Vercel と同様に**トークン表示・ガチャ・Claim 以外の処理ができる。
- **Claim（報酬を受け取る）**: Claim は **Claim API**（SIWE 署名 → サーバ発行の署名 → トランザクション送信）に依存する。**Claim 可能量はサーバー側の game-state（seed）から計算する。** `VITE_CLAIM_API_URL` 設定時はクライアントが **GET/PUT /api/game-state** でサーバーと同期する。デバッグで SEED を増やした場合は、Claim ボタンを押すと**その直前に未送信の状態をサーバーへ送ってから** claim を要求するため、待たずに Claim できる（通常のプレイでも save のたびに約2秒デバウンスでサーバーへ送信）。SAVE ボタンは LOFT タブにのみある（Farming タブにはない）。ローカルで Claim まで検証するには API を同じように設定する。

### 7.2 その他の考え方

- **差異を出さない設計**: 非同期・ウォレット処理にはタイムアウトを設け、エラー時も可能な限りゲーム画面は表示する。PC/スマホで同じコードパスを通す（UA で分岐を増やさない）。
- 検証の細かい手順（エミュレーター・実機）: `docs/DEV_FLOW_AND_MOBILE.md`。

---

## 8. 参照ドキュメント一覧

| 目的 | ファイル |
|------|----------|
| 残タスク・将来実装 | `docs/TODO.md` |
| 開発フロー・スマホ検証 | `docs/DEV_FLOW_AND_MOBILE.md` |
| Claim 安全設計・変更一覧 | `docs/CLAIM_SAFETY_DESIGN.md` |
| 監査指摘への見解 | `docs/AUDIT_RESPONSE.md` |
| 修正後検証チェックリスト | `docs/VERIFICATION.md` |
| ドキュメント格納先・一覧 | `docs/README.md` |
| 起動・仕様・ビルド | リポジトリ直下 `README.md` |

---

更新: 要件を集約し、重複ドキュメントを整理した時点で作成。
