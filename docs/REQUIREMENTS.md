# 要件集約

手戻りを防ぐため、スコープ・方針・制約・検証条件をここに集約する。詳細は各参照ドキュメントへ。

---

## 1. 対応環境（スコープ）

| 項目 | 内容 |
|------|------|
| **対象** | **PC ブラウザ** ＋ **スマホのウォレットアプリ内ブラウザ** のみ。 |
| **対象外** | スマホの通常ブラウザ（Chrome 等）での WalletConnect 対応は**行わない**。 |
| **技術** | Phaser 3 + TypeScript + Vite。ウォレットは EIP-1193（`window.ethereum`）。本番は Sepolia テストネット。 |

---

## 2. 最優先目標

- **Git デプロイ版 ＋ スマホ・メタマスク** でも、**ローカル（PC・Chrome）で確認した動きと同等**にすること。
- 進め方: 「差異を出さない設計」（タイムアウト・フォールバック・同一コードパス）＋ エミュレーター or 実機での検証。細かい UX より先にこの parity を最優先する。
- 詳細: `docs/DEV_FLOW_AND_MOBILE.md` 参照。

---

## 3. 製品仕様（要約）

- **画面上部**: 宝石4種の所持数常時表示。
- **デッキ**: 枠 A〜H（初期 A・B 解放、C〜H はロック／解放可能）。
- **待機リスト**: 所持鳥一覧。鳥クリックで配置先デッキ枠を選択。
- **ガチャ**: $Bird 消費で鳥を獲得。待機リストに追加。
- **宝石増加**: デッキに鳥が1羽以上いるとき経過で Sapphire 増加。
- **$Bird**: 初回ロード時 50000、以降は保存値。データは localStorage に保存（ウォレットアドレスごとに分離）。
- 起動・ビルド・確認手順: リポジトリ直下 `README.md` 参照。

---

## 4. 検証開始条件（DoR）

監査・UI 検証を開始する前に、以下を**手動で**満たしていることを確認する。

1. **TOP が表示される** — タイトル画面（Connect Wallet ボタン）が表示され、崩れ・白画面でないこと。
2. **Connect Wallet が反応する** — クリックで「Connecting...」やゲーム画面への遷移など、何らかの反応があること。
3. **主要画面へ遷移できる** — 接続後、Farming / Deck / Adopt のいずれかのタブで画面が切り替わること。

上記を満たしたうえで検証に進む。検証は手動で行う。

---

## 5. 監査で合意した方針（制約・優先順）

| 順 | 内容 | 方針 |
|----|------|------|
| 1 | Claim API | amount をクライアントから受け取らない。サーバで「このアドレスが引き出せる上限」を計算し、その値だけ署名。CORS 自ドメイン固定 ＋ rate limit。公開環境では実装完了まで claim を無効化（API 側で止める）。 |
| 2 | 権威データ | claimable はサーバ（またはオンチェーン）で計算。クライアントの「表示用」と「サーバが認める claimable」を分離。 |
| 3 | domShell | タブ・共通以外を views に縮退。1・2 のあとのリファクタで実施。 |
| 4 | 自動チェック | ESLint, TS strict, npm audit, build を CI に組み込み。 |
| 5 | XSS / innerHTML | 新規は innerHTML を避け、既存はリファクタ時に textContent/createElement に寄せる。 |

詳細・経緯: `docs/AUDIT_RESPONSE.md`。Claim の具体設計: `docs/CLAIM_SAFETY_DESIGN.md`。

---

## 6. 開発・検証の考え方

- **差異を出さない設計**: 非同期・ウォレット処理にはタイムアウトを設け、エラー時も可能な限りゲーム画面は表示する。PC/スマホで同じコードパスを通す（UA で分岐を増やさない）。
- **検証フロー**: ① ローカル開発 → ② PC Chrome で検証 → ②´ エミュレーター＋メタマスク（任意）→ ③ Git 反映 → ④ 本番 PC で検証 → ⑤ 実機メタマスクで最終確認。
- 詳細（エミュレーター手順・つまずきポイント）: `docs/DEV_FLOW_AND_MOBILE.md`。

---

## 7. 参照ドキュメント一覧

| 目的 | ファイル |
|------|----------|
| 残タスク・将来実装 | `docs/TODO.md` |
| 開発フロー・スマホ検証 | `docs/DEV_FLOW_AND_MOBILE.md` |
| Claim 安全設計・変更一覧 | `docs/CLAIM_SAFETY_DESIGN.md` |
| 監査指摘への見解 | `docs/AUDIT_RESPONSE.md` |
| 修正後検証チェックリスト | `docs/VERIFICATION.md` |
| ドキュメント格納先・一覧 | `docs/README.md` |
| 起動・仕様・ビルド | リポジトリ直下 `README.md` |

---

更新: 要件を集約し、重複ドキュメントを整理した時点で作成。
