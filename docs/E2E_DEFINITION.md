# E2E テスト定義（案）

**目的**: AI が「仕様どおり一通り動くか」を自動で確認し、通るまで PDCA を回してから依頼者に渡す。依頼者側は、渡された時点で E2E が通っている前提で、本番に近い環境・実ウォレットでの検証から始められるようにする。

**前提**: ウォレットは **モック**（`window.ethereum` を差し替えた偽プロバイダ）を使う。実機の MetaMask / Rabby は使わない。

---

## 1. テスト環境

| 項目 | 方針 |
|------|------|
| **実行環境** | テスト用デプロイの URL に E2E がアクセス。Playwright 等でヘッドレスブラウザを起動。CI またはローカルで `npm run test:e2e` を実行。 |
| **ウォレット** | テスト用のモック `window.ethereum` をページ読み込み前に注入。`eth_requestAccounts` → 固定アドレスを返す。`personal_sign` → テスト用鍵で署名して返す。`eth_sendTransaction` 等はモックで成功/失敗を返す。 |
| **API（game-state / claim / auth）** | **C（テスト用デプロイ）**: Vercel プレビュー等、デプロイされた URL を叩く。本物の API を使用（スタブは使わない）。 |
| **チェーン** | 実際の Sepolia は使わない。RPC 呼び出しはモックが受け、固定のレスポンスを返す想定。 |
| **デバイス・viewport** | 下記「デバイス毎の表示」のとおり。 |

---

### デバイス毎の表示（viewport・画面サイズ）

要件では **PC ブラウザ** と **スマホのウォレットアプリ内ブラウザ** の両方が対象で、「差異を出さない設計」が方針。チュートリアル暗転のずれなど、デバイス・画面サイズで起きる表示問題を E2E でどこまで見るかを決める。

| 方針 | 内容 | メリット・デメリット |
|------|------|----------------------|
| **A. 単一 viewport のみ** | 例: デスクトップ幅（1280×720 など）だけでシナリオ 1〜9 を実行。モバイル幅は依頼者の実機検証に任せる。 | 実装・実行が軽い。モバイル幅でのレイアウトずれは E2E では検知しない。 |
| **B. 複数 viewport で同一シナリオ** | デスクトップ（例: 1280×720）とモバイル（例: 375×667 または 390×844）の **2 サイズ** で、それぞれ同じシナリオ 1〜9（チュートリアル含む）を実行する。各 viewport で assert するため、暗転のずれやボタン位置の崩れを検知しやすい。 | 実行時間は約 2 倍。PC とスマホ両方の表示問題を自動で拾える。 |
| **C. デスクトップでフル、モバイルで最小限** | デスクトップではシナリオ 1〜9 をフルに実行。モバイル viewport では「ページが表示されること」「Connect が押せること」「ゲームシェルが出ること」など最小限の assert のみ。 | バランス型。モバイルの致命的な崩れは拾うが、モバイルでのチュートリアル詳細までは見ない。 |
| **D. ビジュアルリグレッション** | 各 viewport でスクリーンショットを撮り、前回と比較する。レイアウトの微妙なずれまで検知できるが、デザイン変更のたびにベースライン更新が必要。 | 変更に敏感。メンテコストがかかる。 |

- **決定**: **B（複数 viewport で同一シナリオ）**。デスクトップ（例: 1280×720）とモバイル（例: 375×667 または 390×844）の 2 サイズで、それぞれ同じシナリオ 1〜9（チュートリアル含む）を実行する。各 viewport で assert するため、暗転のずれやボタン位置の崩れを検知する。

---

## 2. シナリオ一覧（再点検済み）

**観点**: 製造側（AI）は「世界的に有名な Web3 ゲームのデザイナー／エンジニア」として、セキュリティ・UX・一貫した品質を担保する。E2E は**依頼者が実ウォレットで検証する前に実施する門**であり、「このシナリオが通れば、依頼者が同じ手順を実機で実行したときに通るコードパスが壊れていない」ことを保証する。テスト用デプロイ（本物の API）を使うため、環境に依存しすぎない assert にし、フレキシブルな結果は許容する（例: Claim は「成功」でなく「結論が出た」を assert）。

- **オンボーディング**: 仕様では初回は「ADOPT でガチャ → LOFT で配置 → LOFT で SAVE」の順に誘導され、完了まで他タブがロックされる場合がある。シナリオ 6→7→8 がその順序なので、E2E はその流れに沿って進めばよい。誘導 UI が出る場合はそのまま ADOPT へ進む操作を行う。

| # | 項目 | チェック内容（assert の要点） | モック・備考 |
|---|------|------------------------------|----------------|
| **1** | **タイトル表示** | ページ読み込み後、Connect Wallet（または同等文言）が表示され、白画面・致命的な崩れがないこと。 | なし。 |
| **2** | **接続（1回目）** | Connect をクリック → モックが `eth_requestAccounts` に固定アドレスで応答 → **ゲームシェル（タブ付きのメイン画面）が表示されること**。 | モックは `eth_requestAccounts` で一貫したテスト用アドレスを返す。 |
| **3** | **接続（2回目・SIWE）** | Connect に続き `personal_sign`（SIWE）が呼ばれ、モックが**そのアドレスに対応する鍵で署名**して返す。テスト用デプロイの API が署名を検証し、**ゲーム画面がログイン済み状態になること**（タブが有効で、以降の API 呼び出しが 401 で止まらない）。 | モックのアドレスと署名用秘密鍵を対応させておく。サーバーは通常の SIWE 検証のみでよい。 |
| **4** | **ゲーム表示** | **FARMING / ADOPT / LOFT / NETWORK** のタブが存在し、画面上部に **SEED** や **$SEED** らしき表示があること。 | なし。 |
| **5** | **Sepolia 切り替え** | 接続後に `wallet_switchEthereumChain`（または `wallet_addEthereumChain`）が呼ばれ、モックが成功を返す。**その結果、画面がエラーで止まっていないこと**（ネットワークエラー表示が出ず、次の操作に進めること）。 | モックでチェーン切り替えを成功として返す。 |
| **6** | **ガチャ** | **ADOPT タブ**に移り、ガチャボタン（1羽 or 10羽）を押す。モックが `eth_sendTransaction` に成功を返す。**インベントリ（待機リスト）に鳥が増える**等、UI に反映されること。 | オンチェーンはモック。トランザクション成功のみ返す。 |
| **7** | **デッキ配置** | **LOFT タブ**に移り、インベントリの鳥をスロットに配置（クリック or ドラッグ）。**配置された状態が DOM／画面に反映されていること**。 | UI のみ。 |
| **8** | **SAVE** | **LOFT タブの SAVE ボタン**を押す。テスト用デプロイの API（PUT game-state）が成功し、**画面に「保存: 成功」**（またはそれに相当するメッセージ）が出ること。 | 本物の API。409 時は GET 再取得→再 PUT の仕様に従い、最終的に成功メッセージが出ればよい。 |
| **9** | **Claim** | 画面上部の **Claim** を押し、確認モーダルで Confirm。モックが署名取得（/claim）後の `eth_sendTransaction` を受け、成功 or 失敗を返す。**結論がはっきり出ること**を assert：**「Claim successful」または「Nothing to claim」または「Claim failed」＋理由（または Etherscan リンク）」のいずれかが表示される**。クラッシュや無限ローディングで止まらないこと。 | テスト用デプロイの claimable が 0 の場合は「Nothing to claim」でも可。オンチェーン送信はモックで成功/失敗を返す。 |

---

### チュートリアル（オンボーディング）の検証

仕様では初回は「ADOPT でガチャ → LOFT で鳥を配置 → LOFT で SAVE」の順に誘導され、完了まで他タブがロックされる場合がある。E2E でチュートリアルをどこまで検証するか、次のいずれかで決める。

| 方針 | 内容 | メリット・デメリット |
|------|------|----------------------|
| **A. 明示的に検証する** | 接続後に「誘導メッセージやオーバーレイが表示されること」、ガチャ後に「LOFT で配置へ誘導されること」、SAVE 後に「チュートリアル完了やタブアンロック」を assert する。文言やステップが仕様どおりかまで見る。 | チュートリアル UI の変更に E2E が敏感になりやすい。文言変更で落ちる可能性あり。 |
| **B. 検証しない** | チュートリアルは assert しない。シナリオ 6→7→8 の流れ（ADOPT → LOFT 配置 → SAVE）で進むだけ。ロックされていれば自然にその順で進む。「流れが動くこと」は検証するが、「チュートリアルとして表示されていること」は検証しない。 | 実装が軽い。チュートリアルが消えたり文言が壊れても E2E では検知しない。 |
| **C. 最小限だけ検証する** | 初回接続後に「ADOPT 以外のタブがロックされていること」または「誘導 UI が何かしら表示されていること」のどちらかを assert。SAVE 後（またはチュートリアル完了後）に「全タブが有効になっていること」を assert。文言は見ない。 | チュートリアルの「ある／完了」だけを担保。文言変更の影響は受けにくい。 |

- **決定**: **A（明示的に検証する）**。チュートリアル時のみ表示される要素（誘導メッセージ・オーバーレイ・**暗転エリア**など）が、過去にずれや不具合が出ているため、E2E で明示的に assert する。
- **assert する項目（実装時の目安）**:
  - 接続・ログイン後: 誘導メッセージまたはオーバーレイが表示されていること。**暗転エリア**が存在し、意図した範囲・位置にあること（ずれでないこと）。
  - ガチャ後: LOFT で配置へ誘導される表示や状態になっていること。
  - 初回デッキ配置後: SAVE へ誘導される表示や状態になっていること。
  - SAVE 後（チュートリアル完了）: チュートリアル完了が分かる表示、および他タブがアンロックされていること。暗転が解除されていること。

---

## 3. E2E のスコープ（決めたいこと）

以下を一緒に決めていきたいです。

### 3.1 どこまでを「E2E で必須」にするか

- **決定**: **1〜9 すべて**（Claim を含む）。タイトル表示 → 接続（1回目・2回目 SIWE）→ ゲーム表示 → Sepolia 切り替え → ガチャ → デッキ配置 → SAVE → Claim までを E2E でカバーする。

### 3.2 API の扱い

- **決定**: **C（テスト用デプロイ）**。スタブは使わない。
  - E2E は **テスト用デプロイ**（例: Vercel プレビュー、または E2E 専用の Vercel プロジェクト）の URL にアクセスする。本物の API（game-state / auth / claim）を叩くので、品質は本番に近い。
  - 初回は、PR や push でプレビューがデプロイされる CI 連携、またはテスト用プロジェクトの準備が必要になる場合あり。

### 3.3 Claim（9）を E2E に含めるか

- **決定**: **含める**（3.1 で 1〜9 すべて必須とした）。「Claim ボタン押下 → モックが署名取得（/claim 呼び出し）と送信を受け取る → 成功 or 失敗のメッセージが出る」まで assert する。

### 3.3.1 Claim の E2E スコープと本番環境の保証

- **E2E で検証するもの**
  - Claim の**フロー**：ボタン表示 → クリック → Confirm → 何らかの結果モーダル（「Claim successful」「Nothing to claim」「Claim failed」のいずれか）が表示されること。クラッシュや無限ローディングで止まらないこと。
  - **Claim 環境（E2E_REWARD_CLAIM_ADDRESS 設定時のみ）**：シナリオ 9 の直前で、API の signer とコントラクトの `signer()` の一致、報酬プールの RewardClaim への **allowance > 0**、およびプールの **$SEED 残高 > 0** を検証する。不備があれば E2E が失敗し、「Claim simulation failed (transaction would revert)」や `require(false)`（transferFrom 失敗）を**検証時点で解消**する（環境を直してから E2E を通す）。
  - オンチェーン送信は**モック**（`eth_call` / `eth_sendTransaction` は偽の応答）のため、実際の Claim トランザクションは送らない。
- **E2E で検証しないもの**
  - プール残高が「今回の請求量以上か」までは見ない（残高 > 0 であることのみ検証。請求量超過は本番・ステージングで確認）。
- **本番環境で Claim を保証するには**
  - **E2E 実行時に `E2E_REWARD_CLAIM_ADDRESS` を設定する**（テスト用デプロイの RewardClaim アドレス）。E2E が Signer 一致・allowance・プール残高をチェックし、不備なら失敗する。
  - 必要に応じて、本番（またはステージング）で実ウォレットから 1 回 Claim を試すスモークチェックをチェックリストに含める。
  - 環境変数・手順は `docs/VERCEL_ENV_VARS.md` および `docs/CLAIM_DEBUG_HANDOFF.md` を参照する。

### 3.4 実行タイミング

- **決定**: **依頼時**。依頼者が何か修正を依頼したとき、AI は次の流れで動く。
  1. 修正を行う。
  2. E2E を実行する（`npm run test:e2e` 等）。
  3. 問題があれば修正に戻り、2 を繰り返す。
  4. 問題がクリア（E2E が通る）になったら、コミット・プッシュまで行う。
- つまり「渡す＝E2E が通った状態でプッシュ済み」となる。

---

## 4. このドキュメントの使い方

- **決めたいこと**: 上記 3.1〜3.4 について、「○にする／△にする／－にする」「A/B/C のどれにする」等を決めていく。
- **更新**: 決まった内容はこのファイルに反映し、E2E 実装時はこの定義に従う。
- **参照**: REQUIREMENTS.md（仕様）、PATH_TO_VERIFICATION.md（① チェックリスト）と整合させる。

---

## 5. 次のステップ・実行方法

- 定義は決定済み。E2E は実装済み。
  1. **テスト用デプロイ URL をどこで用意するか**  
     **Vercel** でこのリポジトリをデプロイすると URL が発行されます。
     - **本番と同じプロジェクトを使う場合**: Vercel にプロジェクトを 1 つ作り、Git の main ブランチと連携してデプロイする。デプロイ後に表示される **本番 URL**（例: `https://your-app.vercel.app`）を `E2E_BASE_URL` に指定すればよい。構成はシンプルだが、E2E が本番 URL にアクセスすることになる。
     - **E2E 専用プロジェクトにする場合（推奨）**: Vercel で同じリポジトリを指す **別プロジェクト**を 1 つ作り（例: `bird-game-e2e`）、そちらのデプロイ URL を `E2E_BASE_URL` に使う。本番に影響を与えず、E2E 用の環境変数やブランチも分けられる。
     - **どちらがよいか**: 通常は **E2E 専用プロジェクト（2）** を推奨する。理由は、E2E を何度も回しても本番に負荷や影響が出ないこと、テスト用の API キーや設定を本番と分けられること。本番 1 プロジェクトだけ運用したい・E2E が本番を叩いてもよい方針なら 1 でもよい。
     - **方針: E2E 専用プロジェクト（2）で行く** 場合の手順:
       1. [Vercel](https://vercel.com) にログインし、**Add New… → Project** で新規プロジェクトを作成する。
       2. **Import** でこのリポジトリ（例: `bird-game`）を選択する。本番用プロジェクトが既にある場合は、同じリポジトリを「別プロジェクト」としてもう 1 つインポートする。
       3. プロジェクト名を本番と区別する（例: `bird-game-e2e`）。**Framework Preset** は Vite のまま、**Root Directory** 等はそのままでよい。
       4. **Environment Variables** で、本番と同様に `VITE_CLAIM_API_URL` 等（game-state / auth / claim が動くために必要な変数）を設定する。テスト用の値にしたい場合はここで本番と違う値を入れる。
       5. **Deploy** 後、表示される URL（例: `https://bird-game-e2e.vercel.app`）をコピーする。この URL を `E2E_BASE_URL` に設定する（後述の「E2E_BASE_URL の設定方法」参照）。
     - いずれも、E2E で使う API（game-state / auth / claim）がそのデプロイ先で動くように、Vercel の環境変数（`VITE_CLAIM_API_URL` 等）を設定しておく必要があります。
     - **決定: (a) 固定 URL**。上記のどちらかで得た URL を環境変数 **`E2E_BASE_URL`** で指定する。未設定の場合は `http://localhost:5174` にフォールバック（ローカルで `npm run dev` と API の用意が必要）。
  2. **E2E_BASE_URL を設定した方がよい理由**  
     設定すると、接続・SIWE・ガチャ・SAVE・Claim まで本物の API に対して一通り流れるため、**より良いテスト**ができます。未設定でもシナリオ 1（タイトル表示）など一部は動きますが、フルフローを通すにはテスト用デプロイの URL を指定してください。
  3. **E2E_BASE_URL の設定方法**
     - **方法 A（コマンドで渡す）**
       - Mac / Linux: `E2E_BASE_URL=https://あなたのテスト用デプロイURL npm run test:e2e`
       - Windows（PowerShell）: `$env:E2E_BASE_URL="https://あなたのテスト用デプロイURL"; npm run test:e2e`
       - Windows（cmd）: `set E2E_BASE_URL=https://あなたのテスト用デプロイURL && npm run test:e2e`
     - **方法 B（.env に書く）**  
       プロジェクト直下の `.env` に次の 1 行を追加すると、`npm run test:e2e` だけでその URL を使います（Playwright 設定で `dotenv/config` を読み込んでいます）。
       ```
       E2E_BASE_URL=https://あなたのテスト用デプロイURL
       ```
       ※ `.env` は通常 git に含めないので、チームで「テスト用 URL は〇〇」と共有するか、各自の `.env` に書いてください。
  - **Claim 環境チェック（「Claim simulation failed」を E2E で解消する）**
    - テスト用デプロイで Claim まで通す場合、**`E2E_REWARD_CLAIM_ADDRESS`** にそのデプロイの RewardClaim コントラクトアドレスを設定する。E2E がシナリオ 9 の直前に「API signer とコントラクト signer の一致」「プールの RewardClaim への allowance > 0」「プールの $SEED 残高 > 0」を検証し、不備があればテスト失敗で知らせる（プール残高 0 は transferFrom 失敗 → require(false) の主因のため検知する）。
    - 省略可：**`E2E_SEPOLIA_RPC`** で Sepolia の RPC URL を指定（未設定時は `https://ethereum-sepolia-rpc.publicnode.com` を使用）。
    - 例（.env）: `E2E_REWARD_CLAIM_ADDRESS=0x...`（42 文字の 0x 付きアドレス）。
  4. **実行**
     - `npm run test:e2e` … デスクトップ・モバイルの 2 viewport でシナリオ 1〜9 とチュートリアル assert を実行。E2E_BASE_URL 未設定時はローカルで `npm run dev` を自動起動。E2E_REWARD_CLAIM_ADDRESS を設定している場合、Claim 環境（Signer 一致・allowance・プール残高）も検証する。
  5. **初回セットアップ**
     - `npx playwright install` でブラウザをインストール（未インストール時）。
- 依頼時に AI は「修正 → E2E 実行 → 通るまで繰り返し → 通ったらコミット・プッシュ」で動く。
