# 開発フローとスマホ・メタマスク検証の方針

PC版とスマホ版で表示・動きの差異を減らし、⑤（Git版・スマホ・メタマスク）でのつまずきを減らすための方針です。

---

## 現在のフロー

| 段階 | 環境 | 目的 |
|------|------|------|
| ① | ローカル（PC・Chrome） | 開発 |
| ② | ローカル（PC・Chrome） | 検証（ウィンドウ幅の変更含む） |
| ③ | Git に push | 本番環境へ反映 |
| ④ | Git版（PC・Chrome） | 本番ビルドの検証（ウィンドウ幅含む） |
| ⑤ | Git版（スマホ・メタマスク） | 実機・メタマスクブラウザでの検証 ← ここでつまずきやすい |

---

## ローカルで「スマホ・メタマスクブラウザ」を検証する（Android エミュレーター）

**結論: Android エミュレーター ＋ MetaMask アプリを使えば、Git に push する前にメタマスク内ブラウザの挙動をローカルで確認できます。**

### 手順の概要

1. **Android Studio で AVD（エミュレーター）を用意**
   - Android Studio をインストールし、仮想デバイス（AVD）を 1 台作成して起動する。
2. **エミュレーターに MetaMask をインストール**
   - Play ストアから MetaMask をインストール（エミュレーターに Google アカウントが必要な場合あり）。起動してウォレット作成 or インポートまで済ませておく。
3. **PC で開発サーバーを起動**
   - プロジェクトで `npm run dev` を実行（例: ポート 5174）。
4. **エミュレーターから PC のローカルサーバーへアクセス**
   - Android エミュレーターでは、ホスト PC の `localhost` が **`10.0.2.2`** として見える。
   - MetaMask アプリ内のブラウザ（Browser タブなど）で次の URL を開く:  
     **`http://10.0.2.2:5174`**  
     （Vite のポートが 5174 の場合。別ポートならその番号に変更。）
5. **そこで Connect やガチャ・SAVE を実行**
   - 接続・チェーン切り替え・トランザクションが、Git デプロイなしでメタマスク内ブラウザ上で試せる。

### つまずきやすい点

- **接続できない場合**  
  Vite が `127.0.0.1` だけを listen していると、環境によってはエミュレーターから届かないことがある。そのときは `vite.config.ts` の `server` に `host: '0.0.0.0'` を追加し、`http://10.0.2.2:5174` で再度試す。
- **ブロックチェーン**
  - Sepolia などパブリックネットなら、エミュレーターからもインターネット経由で RPC に繋がるのでそのままでよい。
  - ローカル Hardhat チェーン（例: `http://127.0.0.1:8545`）を使う場合は、エミュレーターからは **`http://10.0.2.2:8545`** でアクセスする必要がある。アプリ側で RPC URL を環境に応じて切り替えるか、.env で `10.0.2.2` を参照する必要がある。
- **iOS**
  - iOS シミュレーターには MetaMask がインストールできない、または実機と挙動が違うことが多い。メタマスク内ブラウザの検証は **Android エミュレーター or 実機** で行う想定がよい。

### フローに組み込む場合

- ②の「ローカル検証」の一部として、**②´ ローカル（Android エミュレーター・メタマスクブラウザ）で検証** を追加できる。
- 流れの例: ① 開発 → ② PC Chrome で検証 → **②´ エミュレーター＋メタマスクで接続・ガチャ・SAVE を確認** → ③ Git 反映 → ④ 本番 PC で検証 → ⑤ 実機メタマスクで最終確認。  
  ②´ で多くのメタマスク起因の不具合を拾えるため、⑤のつまずきを減らしやすくなります。

---

## ⑤でつまずく主な理由

- **メタマスクアプリ内ブラウザ**は、PC Chrome とは別環境（フォーカス・ダイアログの戻り方、タイマー、ネットワーク状態などが異なる）。
- ①～④では再現しづらく、**⑤で初めて発覚する**ことが多い。
- 実機でしか確認できないため、原因切り分けに時間がかかる。

---

## 方針: 「差異を出さない設計」＋「⑤で壊れても原因をすぐ把握」

### 1. 差異を出さない設計（コード側でできること）

- **非同期・ウォレットまわり**
  - ウォレット接続・チェーン切り替え・RPC 呼び出しには**必ずタイムアウト**を設ける。メタマスクブラウザで応答が返らない場合でも、UI が「固まったまま」にならないようにする。
  - エラーやタイムアウト時も**可能な限りゲーム画面は表示する**（例: 接続後処理が失敗しても showGameShell / createPhaserGame まで実行）。「進めない」状態を減らす。
- **1本のコードパス**
  - PC/スマホで**分岐させず同じ処理**を通す（UA で特別扱いする箇所を増やさない）。デバイス差は「タイムアウト長さ」や「フォールバックの有無」で吸収する。
- **クリティカルパスのチェックリスト**
  - Connect → ゲーム表示、ガチャ、SAVE、Claim など、**必須の流れ**だけリスト化し、PR やデプロイ前に「ここはタイムアウト／try-catch 済みか」を確認する。細かい見た目より先に、**動線が止まらないこと**を優先する。

これらを「スマホ・メタマスクでも同じように動く前提」で書いておくと、⑤で起きる不具合の種類が減ります。

### 2. ⑤で壊れたときに原因を早く特定する

- **実機デバッグ**
  - **Android**: PC と USB 接続し、Chrome の `chrome://inspect` で「メタマスク内ブラウザ」のページを inspect。コンソール・ネットワークを PC で確認できる。
  - **iOS**: Safari の Web Inspector で実機の Safari は見られるが、メタマスク内ブラウザは制約あり。その分、**画面上のエラー表示**が重要。
- **画面上でのエラー情報**
  - 重要なエラー（接続失敗、タイムアウト、RPC エラーなど）で、**短いメッセージを画面に表示**する（alert だけだとスクショしづらいので、モーダルやバナーに一文出すだけでもよい）。⑤で不具合が出たときに「何が起きたか」をスクショで残せるようにする。
- **検証チェックリスト**
  - ⑤用に「Connect → Sepolia 切り替え → ガチャ → デッキ SAVE → Claim のうち、どこまでできたか」をメモする簡易チェックリストを用意する。毎回でなくても、不具合が出た回だけ記録すると、傾向が見えやすい。

### 3. 運用面での効率化

- **細かい修正は後回し**
  - 表示の微調整や「あるとよい」系は、**PC/スマホで動線が同じか・止まらないか**を安定させてから回す。優先度は「動きの安定・差異の解消」＞「細かい UX 改善」。
- **④まででやれるだけやる**
  - ④の時点で、**レスポンシブ（ウィンドウ幅変更）** と **コンソールエラーなし** を確認。⑤は「メタマスク・実機ならでは」の部分の確認に集中する。
- **デプロイ単位**
  - 「メタマスクまわり／接続まわり」を触ったときは、**その PR を push したあと、可能なら一度⑤を短くでよいので通す**習慣にすると、問題の入り込みポイントが分かりやすい。

---

## まとめ

- **優先度**: PC版とスマホ版で**表示・動きの差異を出さず安定させる**こと。細かい修正はその後。
- **設計**: 非同期・ウォレット処理はタイムアウトとフォールバックで「止まらない」ようにする。PC/スマホで同じコードパスを通す。
- **検証**: ⑤で失敗したら、実機デバッグ or 画面のエラー表示で原因をすぐ把握できるようにする。必要なら⑤用の短いチェックリストで「どこで落ちたか」を記録する。

この方針で進めると、⑤のつまずきを「なくす」だけでなく「起きても原因を早く特定し、修正を ①～④ にフィードバックする」ループが回りやすくなります。
