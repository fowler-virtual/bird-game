# ゲーム状態同期 仕様書（サーバー正・「データ更新でタイトル戻し」方式）

## 1. 目的

- 同一ウォレットアドレスで、PC・スマホ・ブラウザを問わず **同じ進行状態** を表示・更新する。
- 別デバイスでデータが更新された場合は、他デバイスでは **「データの更新がありました」と表示してタイトルに戻し、最新を取得する**。マージは行わない。

---

## 2. 用語

| 用語 | 意味 |
|------|------|
| **サーバー正** | 進行状態の「正」はサーバーに 1 件だけ存在する。クライアントは読み取り・更新要求のみ。 |
| **バージョン** | そのアドレスの状態が更新されるたびに 1 増やす整数。同一アドレスで一意に増加する。 |
| **古い（stale）** | クライアントが持っているバージョンが、サーバーの現在バージョンより小さいこと。 |
| **SEED** | ゲーム内でファーミング（放置）により増える通貨。state.seed で保持。 |
| **$SEED** | チェーン上で保持・Claim 等でやり取りする交換用トークン。ガチャや Loft アップグレードのコストはオンチェーンの $SEED で支払う。（$Bird は廃止済み。） |

---

## 3. 保存するデータ

### 3.1 サーバーが保持するもの（1 アドレスあたり 1 レコード）

- **version** (number): 更新のたびに 1 増加。初期値 1。
- **state** (object): ゲーム状態（下記スキーマ）。うち **seed** がゲーム内ファーミングの SEED。
- **updatedAt** (string, optional): ISO8601 の最終更新時刻。監視・デバッグ用。

※ $SEED はオンチェーンで管理。ガチャ・Loft アップグレードに必要なコストはオンチェーンの $SEED とする。同期対象の state にはゲーム内 SEED（state.seed）のみ含める。

### 3.2 ゲーム状態（state）のスキーマ

現行クライアントの `GameState` と互換の形とする。持ち帰り通貨は **SEED のみ**（宝石は廃止）。

- **birdsOwned**: Bird[] （id, rarity, createdAt, species?, color?）
- **deckSlots**: (string | null)[] （鳥 ID または null、スロット数は 12）
- **lastAccrualAt**: string (ISO8601)
- **unlockedDeckCount**: number（2, 4, 6, 8, 10, 12 のいずれか）
- **loftLevel**: number（1〜6）
- **inventory**: Record<string, number>（BirdTypeKey ごとの待機数）
- **hasFreeGacha**: boolean
- **hasShownPlacementHint**: boolean
- **seed**: number（0 以上）＝ ゲーム内でファーミングできる **SEED**
- **onboardingStep**: 'need_gacha' | 'need_place' | 'need_save' | 'need_farming' | 'done'
- **gems** (廃止): 以前は sapphire / ruby / emerald / diamond を持ち帰る設定だったが、現在は SEED のみ。互換のためフィールドが残っている場合は 0 固定または省略してよい。

### 3.3 初期状態

- そのアドレスで初めて GET した場合、サーバーにレコードが無ければ **初期状態** を返す。
- 初期状態: 上記スキーマのデフォルト（birdsOwned [], deckSlots 12 スロット null, lastAccrualAt 現在時刻, unlockedDeckCount 2, loftLevel 1, inventory {}, hasFreeGacha true, hasShownPlacementHint false, seed 0, onboardingStep 'need_gacha'）。持ち帰りは SEED のみ（宝石系は廃止済みのため 0 または省略可）。
- 初期状態を返すときは **version: 1** とする（この時点ではサーバーにまだ保存していないため、次回 PUT で version 1 として上書き可能とする、または GET 時にレコードを作成して version 1 で返すかは実装で決める）。

---

## 4. 認証

- Claim API と同様に **SIWE セッション（Cookie）** を必須とする。
- リクエスト時、サーバーはセッションからアドレスを取得し、**そのアドレスのデータのみ** 読み書きする。
- 未認証の場合は 401 を返す。

---

## 5. API

### 5.1 GET /game-state（状態取得）

- **認証**: 必須（SIWE セッション）。
- **レスポンス**:
  - 200: `{ state, version [, updatedAt ] }`
  - そのアドレスにレコードが無い場合は **初期状態 + version 1** を返す。
- **用途**: 起動時・タイトル表示後・「データ更新されました」でタイトルに戻ったあとの再読み込み。

### 5.2 PUT /game-state（状態保存）

- **認証**: 必須（SIWE セッション）。
- **リクエストボディ**: `{ state, version }`
  - **version**: クライアントが **取得したときの** バージョン番号。サーバーは「この version で更新してよい」と判断するために使う。
- **サーバー処理**:
  1. 現在のそのアドレスの **サーバー側 version**（current）を取得。
  2. リクエストの **version**（client）と比較。
  3. **client < current** の場合: **別デバイスで更新済み** とみなす。保存せず **409 Conflict** を返す。ボディに `{ code: 'STALE_DATA', message: '...' }` のような形で理由を含める（任意）。
  4. **client === current** の場合: リクエストの state を **検証**（下記）。OK なら上書きし、version を **current + 1** に更新。200 で `{ version: current+1 }` を返す。
  5. **client > current** の場合は不正（通常は起きない）。409 または 400 で拒否してよい。
- **レスポンス**:
  - 200: `{ version }` （更新後のバージョン）
  - 409: 古いデータ（クライアントは「データ更新されました」を表示してタイトルへ）
  - 400: 検証エラー（ボディに理由）
  - 401: 未認証

### 5.3 （任意）GET /game-state/version

- 軽量に「今のバージョンだけ」取得したい場合に使用。
- 認証必須。レスポンス例: `{ version }`。
- ポーリングする場合はこのエンドポイントを定期的に呼ぶ。実装は任意。

---

## 6. サーバー側検証（PUT 時）

- 型・範囲のチェック: 数値の範囲、配列長、必須キー存在。
- **参照整合性**: deckSlots に含まれる鳥 ID は、すべて birdsOwned に存在すること。
- **ビジネスルール**: 必要に応じて（例: seed（SEED）が負でない、unlockedDeckCount が 2〜12 の偶数、など）。  
  厳密なガチャ整合（消費通貨と鳥の増減）までサーバーで検証するかは別フェーズで検討可能。まずは「形と参照整合性」を必須とする。

---

## 7. クライアント側の振る舞い

### 7.1 起動・ゲーム画面に入るとき

1. SIWE が済んでいることを前提に、**GET /game-state** で状態を取得。
2. 取得した **state, version** をメモリ（および必要なら localStorage のキャッシュ）に保持。**表示の正はサーバーから取得したこの 1 件**とする。
3. 以降、画面での操作（ガチャ・デッキ変更・時間経過など）は、この state を更新し、**保存が必要なタイミング**（下記）で PUT する。

### 7.2 保存のタイミング

- **デバウンス**: 状態が変わってから **一定時間（例: 1.5〜2 秒）** 経過した時点で PUT する。連続操作では最後の変更から 2 秒後に 1 回だけ送る。
- **その他**: タブを閉じる前（beforeunload）、または画面遷移でゲームを離れる前など、**重要な離脱時**にも 1 回 PUT する（可能な範囲で）。
- 保存時は必ず **取得済みの version** をそのまま PUT のボディに含める。

### 7.3 PUT のレスポンスが 409 のとき

1. **「データの更新がありました。タイトル画面に戻ります。」** のようなメッセージを表示する。
2. **タイトル画面に遷移**する（ゲームシェルを閉じ、TOP の Connect 済み状態に戻す、または TOP の Connect 前まで戻すかは UX で決定）。
3. タイトルで **GET /game-state** を再度実行し、**最新の state, version** で画面を初期化する。ユーザーは同じウォレットで再度ゲームを開けば、最新状態で遊べる。

### 7.4 PUT のレスポンスが 200 のとき

- 返ってきた **version** をクライアントの「取得済みバージョン」として保持する。次回 PUT ではこの version を送る。

### 7.5 オフライン・保存失敗

- ネットエラーなどで PUT が失敗した場合: 「保存に失敗しました。通信環境を確認のうえ、再度お試しください。」等を表示。**サーバーは更新していない**ので、再試行時は同じ version で再度 PUT してよい。
- 長時間オフラインのあとオンラインに戻った場合: 再開時に **GET /game-state** を実行し、サーバーの最新状態で上書きする。これにより「サーバー正」を維持する。

---

## 8. バージョン比較のルール（まとめ）

- サーバーは **そのアドレスの現在バージョン** を 1 つだけ持つ。
- PUT では **client が持っている version** を送る。
- **client === サーバー現在** のときだけ上書きし、サーバー現在を +1 する。
- **client < サーバー現在** のときは「別デバイスで更新済み」→ 409 を返し、クライアントはタイトルに戻して再取得。

---

## 9. メッセージ文案（例）

| 場面 | 文言例 |
|------|--------|
| 別デバイスで更新された（409） | 「データの更新がありました。タイトル画面に戻ります。」 |
| 保存失敗（ネットエラー等） | 「保存に失敗しました。通信環境を確認のうえ、再度お試しください。」 |

---

## 10. 既存機能との関係

- **localStorage**: サーバー同期を入れたあとも、**オフライン用キャッシュ** や **SIWE 前の一時表示** に使うかは実装で決める。**「正」は常にサーバー**。タイトルに戻ったあとは必ず GET で最新を取得する。
- **Claim / オンチェーン**: 既存の Claim API やオンチェーン（デッキ SAVE、Loft など）は変更しない。ゲーム状態の「同期」だけをこの仕様で追加する。
- **認証**: 既存の SIWE（Claim 用）と共通化する。ゲーム状態用に別セッションは作らない。

---

## 11. 実装順序の提案

1. サーバー: GET/PUT エンドポイントの追加、version 付きの 1 アドレス 1 レコード保存、409 の返却、最小限の検証。
2. クライアント: GET で起動時・タイトル戻り後に取得、表示の正をサーバーに切り替え、保存はデバウンスで PUT、409 時にメッセージ表示＋タイトルへ戻す＋再取得。
3. 必要に応じて GET /game-state/version とポーリングを追加。

以上を「データ更新でタイトル戻し」方式の具体的な仕様とする。
